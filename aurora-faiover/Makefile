.PHONY: help terraform-init terraform-plan terraform-apply terraform-destroy docker-build docker-push ecr-login setup plan apply deploy destroy clean ecs-deploy ecs-status ecs-logs ecs-exec ecs-update ecs-run-monitor ecs-stop-monitor

# Variables
AWS_VAULT_PROFILE = mizzy
TERRAFORM_DIR = terraform
DOCKER_DIR = docker
ECSPRESSO_DIR = ecspresso
TAG ?= latest

# Default target
help:
	@echo "ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  setup           - åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆterraform initï¼‰"
	@echo "  plan            - Terraformãƒ—ãƒ©ãƒ³ã®è¡¨ç¤º"
	@echo "  apply           - Terraformã®é©ç”¨"
	@echo "  deploy          - ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  destroy         - ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®å‰Šé™¤"
	@echo "  docker-build    - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰"
	@echo "  docker-push     - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ECRãƒ—ãƒƒã‚·ãƒ¥"
	@echo "  ecr-login       - ECRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³"
	@echo "  ecs-deploy      - ECSã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  ecs-status      - ECSã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª"
	@echo "  ecs-logs        - ECSã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°è¡¨ç¤º"
	@echo "  ecs-exec        - ECSã‚³ãƒ³ãƒ†ãƒŠã¸ã®æ¥ç¶š"
	@echo "  ecs-update      - ECSã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥ï¼‹ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰"
	@echo "  ecs-delete      - ECSã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤"
	@echo "  ecs-run-monitor - DBãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œ"
	@echo "  ecs-stop-monitor- DBãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã®åœæ­¢"
	@echo "  ecs-delete-monitor - DBãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤"
	@echo "  clean           - ãƒ­ãƒ¼ã‚«ãƒ«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo ""
	@echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
	@echo "  TAG=<version>   - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ã‚’æŒ‡å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: latestï¼‰"

# Terraform operations
setup:
	@echo "Terraformã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œä¸­..."
	cd $(TERRAFORM_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- terraform init

plan:
	@echo "Terraformãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤ºä¸­..."
	cd $(TERRAFORM_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- terraform plan

apply:
	@echo "Terraformã‚’é©ç”¨ä¸­..."
	cd $(TERRAFORM_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- terraform apply

deploy: apply
	@echo "ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

destroy:
	@echo "ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’å‰Šé™¤ä¸­..."
	@echo "ECSãƒªã‚½ãƒ¼ã‚¹ã‚’å…ˆã«å‰Šé™¤..."
	@make ecs-delete-monitor || true
	@make ecs-delete || true
	@echo "Terraformãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤..."
	cd $(TERRAFORM_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- terraform destroy

# Docker operations
docker-build:
	@echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	cd $(DOCKER_DIR) && docker build --platform linux/amd64 -t aurora-failover-typescript-app:$(TAG) .

ecr-login:
	@echo "ECRã«ãƒ­ã‚°ã‚¤ãƒ³ä¸­..."
	cd $(TERRAFORM_DIR) && \
	ECR_REPOSITORY_URL=$$(aws-vault exec $(AWS_VAULT_PROFILE) -- terraform output -raw ecr_repository_url) && \
	aws-vault exec $(AWS_VAULT_PROFILE) -- aws ecr get-login-password --region ap-northeast-1 | \
	docker login --username AWS --password-stdin $$ECR_REPOSITORY_URL

docker-push: docker-build ecr-login
	@echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ECRã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
	cd $(TERRAFORM_DIR) && \
	ECR_REPOSITORY_URL=$$(aws-vault exec $(AWS_VAULT_PROFILE) -- terraform output -raw ecr_repository_url) && \
	docker tag aurora-failover-typescript-app:$(TAG) $$ECR_REPOSITORY_URL:$(TAG) && \
	aws-vault exec $(AWS_VAULT_PROFILE) -- docker push $$ECR_REPOSITORY_URL:$(TAG) && \
	echo "âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒå®Œäº†ã—ã¾ã—ãŸ!" && \
	echo "ã‚¤ãƒ¡ãƒ¼ã‚¸URI: $$ECR_REPOSITORY_URL:$(TAG)"

# Utility operations
clean:
	@echo "ãƒ­ãƒ¼ã‚«ãƒ«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	docker rmi -f aurora-failover-typescript-app:$(TAG) 2>/dev/null || true
	@echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# Combined operations
full-deploy: setup deploy docker-push
	@echo "ğŸ‰ ãƒ•ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†!"

# ECS operations with ecspresso
ecs-deploy:
	@echo "ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- ecspresso deploy --config ecspresso.yml

ecs-status:
	@echo "ECSã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
	cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- ecspresso status --config ecspresso.yml

ecs-logs:
	@echo "ECSã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã‚’è¡¨ç¤ºä¸­..."
	cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- ecspresso logs --config ecspresso.yml --follow

ecs-exec:
	@echo "ECSã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶šä¸­..."
	cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- ecspresso exec --config ecspresso.yml --container app -- /bin/bash

ecs-update: docker-push
	@echo "ğŸš€ ECSã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°å®Œäº†!"

# ECS monitoring operations
ecs-run-monitor:
	@echo "DBãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œä¸­ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤ºï¼‰..."
	@echo "Ctrl+Cã§åœæ­¢ã§ãã¾ã™"
	@bash -c 'trap "echo \"\nğŸ“¥ Ctrl+C detected, stopping monitor task...\"; aws-vault exec $(AWS_VAULT_PROFILE) -- aws ecs list-tasks --cluster aurora-failover-test-cluster --family aurora-failover-db-monitor --query \"taskArns[0]\" --output text | xargs -I {} aws-vault exec $(AWS_VAULT_PROFILE) -- aws ecs stop-task --cluster aurora-failover-test-cluster --task {} > /dev/null; exit 0" INT; cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- ecspresso run --config ecspresso-monitor.yml --watch-container db-monitor'

ecs-stop-monitor:
	@echo "DBãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚’åœæ­¢ä¸­..."
	@TASK_ARN=$$(cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- aws ecs list-tasks --cluster aurora-failover-test-cluster --family aurora-failover-db-monitor --query 'taskArns[0]' --output text); \
	if [ "$$TASK_ARN" != "None" ] && [ -n "$$TASK_ARN" ]; then \
		aws-vault exec $(AWS_VAULT_PROFILE) -- aws ecs stop-task --cluster aurora-failover-test-cluster --task $$TASK_ARN > /dev/null; \
		echo "ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚’åœæ­¢ã—ã¾ã—ãŸ"; \
	else \
		echo "å®Ÿè¡Œä¸­ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“"; \
	fi

# ECS service deletion with ecspresso
ecs-delete:
	@echo "ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ä¸­..."
	@echo "ã‚µãƒ¼ãƒ“ã‚¹ã‚’0ã«ã‚¹ã‚±ãƒ¼ãƒ«..."
	cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- ecspresso scale --config ecspresso.yml --tasks 0 || true
	@echo "ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤..."
	cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- ecspresso delete --config ecspresso.yml --force || true

ecs-delete-monitor:
	@echo "DBãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­..."
	@echo "å®Ÿè¡Œä¸­ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚’åœæ­¢..."
	@make ecs-stop-monitor || true
	@echo "ãƒ¢ãƒ‹ã‚¿ãƒ¼ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤..."
	cd $(ECSPRESSO_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- ecspresso delete --config ecspresso-monitor.yml --force || true

# Show terraform outputs
outputs:
	@echo "Terraformå‡ºåŠ›å€¤:"
	cd $(TERRAFORM_DIR) && aws-vault exec $(AWS_VAULT_PROFILE) -- terraform output
